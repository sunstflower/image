<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + React + TS</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      (async () => {
        try {
          // 直接获取模块源码，生成 blob URL，绕过 Vite 对 /public 的 import 分析
          const jsResp = await fetch('/pkg/rustimage_wasm.js')
          const jsCode = await jsResp.text()
          const blobUrl = URL.createObjectURL(new Blob([jsCode], { type: 'text/javascript' }))

          const mod = await import(blobUrl)
          await mod.default('/pkg/rustimage_wasm_bg.wasm')

          window.rustimage_wasm = mod
          window.dispatchEvent(new Event('rustimage-wasm-ready'))
          console.info('[WASM] initialized')
        } catch (e) {
          console.error('[WASM] init failed', e)
        }
      })();
    </script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
